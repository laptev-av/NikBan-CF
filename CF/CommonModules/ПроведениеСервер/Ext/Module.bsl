
#Область ПрограммныйИнтерфейс

#Область ПроцедурыДляПодготовкиИЗаписиДвиженийДокумента

// Процедура инициализирует общие структуры, используемые при проведении документов.
// Вызывается из модуля документов при проведении.
//
Процедура ИнициализироватьДополнительныеСвойстваДляПроведения(ДокументСсылка, ДополнительныеСвойства, РежимПроведения = Неопределено) Экспорт

	// В структуре "ДополнительныеСвойства" создаются свойства с ключами "ТаблицыДляДвижений", "ДляПроведения".

	// "ТаблицыДляДвижений" - структура, которая будет содержать таблицы значений с данными для выполнения движений.
	ДополнительныеСвойства.Вставить("ТаблицыДляДвижений", Новый Структура);

	// "ДляПроведения" - структура, содержащая свойства и реквизиты документа, необходимые для проведения.
	ДополнительныеСвойства.Вставить("ДляПроведения", Новый Структура);
	
	// Структура, содержащая ключ с именем "МенеджерВременныхТаблиц", в значении которого хранится менеджер временных
	// таблиц.
	// Содержит для каждой временной таблицы ключ (имя временной таблицы) и значение (признак наличия записей во временной
	// таблице).
	ДополнительныеСвойства.ДляПроведения.Вставить("СтруктураВременныеТаблицы", Новый Структура("МенеджерВременныхТаблиц", Новый МенеджерВременныхТаблиц));
	ДополнительныеСвойства.ДляПроведения.Вставить("РежимПроведения",           РежимПроведения);
	ДополнительныеСвойства.ДляПроведения.Вставить("МетаданныеДокумента",       ДокументСсылка.Метаданные());
	ДополнительныеСвойства.ДляПроведения.Вставить("Ссылка",                    ДокументСсылка);
	
	ДополнительныеСвойства.Вставить("ИспользуетсяКомиссионнаяТорговля", ПолучитьФункциональнуюОпцию("ИспользоватьКомиссионнуюТорговлю"));
	ДополнительныеСвойства.Вставить("ИспользуетсяУчетИмпортныхТоваров", ПолучитьФункциональнуюОпцию("ИспользоватьУчетИмпортныхТоваров"));
	
КонецПроцедуры

// Процедура закрывает МВТ, используемый при формировании движений.
//
Процедура ОчиститьДополнительныеСвойстваДляПроведения(ДополнительныеСвойства) Экспорт

	ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц.Закрыть();

КонецПроцедуры

// Функция формирует массив имен регистров, по которым документ имеет движения.
// Вызывается при подготовке записей к регистрации движений.
//
Функция ПолучитьМассивИспользуемыхРегистров(Регистратор, Движения, МассивИсключаемыхРегистров = Неопределено) Экспорт

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Регистратор", Регистратор);

	Результат = Новый Массив;
	МаксимумТаблицВЗапросе = 256;

	СчетчикТаблиц   = 0;
	СчетчикДвижений = 0;

	ВсегоДвижений = Движения.Количество();
	ТекстЗапроса  = "";
	Для Каждого Движение Из Движения Цикл

		СчетчикДвижений = СчетчикДвижений + 1;

		ПропуститьРегистр = МассивИсключаемыхРегистров <> Неопределено
							И МассивИсключаемыхРегистров.Найти(Движение.Имя) <> Неопределено;

		Если Не ПропуститьРегистр Тогда

			Если СчетчикТаблиц > 0 Тогда

				ТекстЗапроса = ТекстЗапроса 
				+ "
				|ОБЪЕДИНИТЬ ВСЕ
				|";

			КонецЕсли;

			СчетчикТаблиц = СчетчикТаблиц + 1;

			ТекстЗапроса = ТекстЗапроса 
			+ "
			|ВЫБРАТЬ ПЕРВЫЕ 1
			|""" + Движение.Имя + """ КАК ИмяРегистра
			|
			|ИЗ " + Движение.ПолноеИмя() + "
			|
			|ГДЕ Регистратор = &Регистратор
			|";

		КонецЕсли;

		Если СчетчикТаблиц = МаксимумТаблицВЗапросе Или СчетчикДвижений = ВсегоДвижений Тогда

			Запрос.Текст  = ТекстЗапроса;
			ТекстЗапроса  = "";
			СчетчикТаблиц = 0;

			Если Результат.Количество() = 0 Тогда

				Результат = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ИмяРегистра");

			Иначе

				Выборка = Запрос.Выполнить().Выбрать();
				Пока Выборка.Следующий() Цикл
					Результат.Добавить(Выборка.ИмяРегистра);
				КонецЦикла;

			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	Возврат Результат;

КонецФункции

// Процедура выполняет подготовку наборов записей документа к записи движений.
// 1. Очищает наборы записей от "старых записей" (ситуация возможна только в толстом клиенте).
// 2. Взводит флаг записи у наборов, по которым документ имеет движения.
// Вызывается из модуля документов при проведении.
//
Процедура ПодготовитьНаборыЗаписейКРегистрацииДвижений(Объект) Экспорт

	Для Каждого НаборЗаписей Из Объект.Движения Цикл

		Если НаборЗаписей.Количество() > 0 Тогда
			НаборЗаписей.Очистить();
		КонецЕсли;

	КонецЦикла;

	Если Не Объект.ДополнительныеСвойства.ЭтоНовый Тогда

		// Регистры, движения по которым формируются не из модуля менеджера документа.
		ИсключаемыеРегистры = Новый Массив;
		
		МассивИменРегистров = ПолучитьМассивИспользуемыхРегистров(Объект.Ссылка,
				Объект.ДополнительныеСвойства.ДляПроведения.МетаданныеДокумента.Движения,
				ИсключаемыеРегистры);

		Для Каждого ИмяРегистра Из МассивИменРегистров Цикл
			Объект.Движения[ИмяРегистра].Записывать = Истина;
		КонецЦикла;

	КонецЕсли;

КонецПроцедуры

// Процедура записывает движения документа. Дополнительно происходит копирование параметров
// в модули наборов записей для выполнения регистрации изменений в движениях.
// Процедура вызывается из модуля документов при проведении.
//
Процедура ЗаписатьНаборыЗаписей(Знач Объект) Экспорт
	Перем РегистрыДляКонтроля;

	
	// Регистры, для которых будут рассчитаны таблицы изменений движений.
	Если Объект.ДополнительныеСвойства.ДляПроведения.Свойство("РегистрыДляКонтроля", РегистрыДляКонтроля) Тогда
		Для Каждого НаборЗаписей Из РегистрыДляКонтроля Цикл
			Если НаборЗаписей.Записывать Тогда

				// Установка флага регистрации изменений в наборе записей.
				НаборЗаписей.ДополнительныеСвойства.Вставить("РассчитыватьИзменения", Истина);
				НаборЗаписей.ДополнительныеСвойства.Вставить("ЭтоНовый", Объект.ДополнительныеСвойства.ЭтоНовый);

				// Структура для передачи данных в модули наборов записей.
				НаборЗаписей.ДополнительныеСвойства.Вставить("ДляПроведения", 
						Новый Структура("СтруктураВременныеТаблицы", Объект.ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы));

			КонецЕсли;
		КонецЦикла;
	КонецЕсли;

	
	Объект.Движения.Записать();

КонецПроцедуры

#КонецОбласти

#Область ПроцедурыКонтроляДвиженийДокументовПоРегистрам

// Функция проверяет наличие изменений в таблице регистра.
//
Функция ЕстьИзмененияВТаблице(СтруктураДанных, Ключ)
	Перем ЕстьИзменения;

	Возврат СтруктураДанных.Свойство(Ключ, ЕстьИзменения) И ЕстьИзменения;

КонецФункции

// Процедура выполняет контроль результатов проведения.
// Процедура вызывается из модуля документов при проведении.
//
Процедура ВыполнитьКонтрольРезультатовПроведения(Объект, Отказ) Экспорт

	Если Объект.ДополнительныеСвойства.ДляПроведения.РегистрыДляКонтроля.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	ДанныеТаблиц    = Объект.ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;
	ПакетЗапросов   = Новый Запрос;
	МассивКонтролей = Новый Массив;
	ТекстЗапроса    = "";

	// Контроль отрицательных остатков по товарам на складах.
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц,"ДвиженияТоварыНаСкладахИзменение") Тогда

		МассивКонтролей.Добавить(Врег("ТоварыНаСкладах"));
		ТекстЗапроса = ТекстЗапроса 
		+ "ВЫБРАТЬ
		|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладахОстатки.Характеристика КАК Характеристика,
		|	ТоварыНаСкладахОстатки.Склад КАК Склад,
		|	ТоварыНаСкладахОстатки.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	ТоварыНаСкладахОстатки.КоличествоОстаток,
		|	ТоварыНаСкладахОстатки.РезервОстаток,
		|	ТоварыНаСкладахОстатки.КоличествоОстаток - ТоварыНаСкладахОстатки.РезервОстаток  КАК Количество
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|			,
		|			(Номенклатура, Характеристика, Склад) В
		|				(ВЫБРАТЬ
		|					Таблица.Номенклатура,
		|					Таблица.Характеристика,
		|					Таблица.Склад
		|				ИЗ
		|					ДвиженияТоварыНаСкладахИзменение КАК Таблица)) КАК ТоварыНаСкладахОстатки
		|ГДЕ
		|	ТоварыНаСкладахОстатки.КоличествоОстаток - ТоварыНаСкладахОстатки.РезервОстаток < 0;
		|///////////////////////////////////////////////////////////////////
		|";

		
	КонецЕсли;
		
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц,"ДвиженияДвиженияСерийныхНомеровИзменение") Тогда 
		
		МассивКонтролей.Добавить(Врег("ДвиженияСерийныхНомеров"));
		
		ТекстЗапроса = ТекстЗапроса + "
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.Номенклатура,
		|	ВложенныйЗапрос.СерийныйНомер,
		|	ВложенныйЗапрос.Склад,
		|	ВложенныйЗапрос.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	ВложенныйЗапрос.Количество
		|ИЗ
		|	(ВЫБРАТЬ
		|		ВложенныйЗапрос.Номенклатура КАК Номенклатура,
		|		ВложенныйЗапрос.СерийныйНомер КАК СерийныйНомер,
		|		ВложенныйЗапрос.Склад КАК Склад,
		|		ВложенныйЗапрос.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|		СУММА(ВложенныйЗапрос.Количество) КАК Количество
		|	ИЗ
		|		(ВЫБРАТЬ
		|			ДвиженияСерийныхНомеров.Номенклатура КАК Номенклатура,
		|			ДвиженияСерийныхНомеров.СерийныйНомер КАК СерийныйНомер,
		|			ДвиженияСерийныхНомеров.Получатель КАК Склад,
		|			ДвиженияСерийныхНомеров.Количество КАК Количество
		|		ИЗ
		|			РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
		|		ГДЕ
		|			(ДвиженияСерийныхНомеров.Номенклатура, ДвиженияСерийныхНомеров.СерийныйНомер, ДвиженияСерийныхНомеров.Получатель) В
		|					(ВЫБРАТЬ
		|						Таблица.Номенклатура,
		|						Таблица.СерийныйНомер,
		|						Таблица.Склад
		|					ИЗ
		|						ДвиженияДвиженияСерийныхНомеровИзменение КАК Таблица)
		|			И (НЕ ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов))
		|			И (НЕ ДвиженияСерийныхНомеров.Получатель = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))
		|		
		|		ОБЪЕДИНИТЬ ВСЕ
		|		
		|		ВЫБРАТЬ
		|			ДвиженияСерийныхНомеров.Номенклатура,
		|			ДвиженияСерийныхНомеров.СерийныйНомер,
		|			ДвиженияСерийныхНомеров.Отправитель,
		|			-ДвиженияСерийныхНомеров.Количество
		|		ИЗ
		|			РегистрСведений.ДвиженияСерийныхНомеров КАК ДвиженияСерийныхНомеров
		|		ГДЕ
		|			(ДвиженияСерийныхНомеров.Номенклатура, ДвиженияСерийныхНомеров.СерийныйНомер, ДвиженияСерийныхНомеров.Отправитель) В
		|					(ВЫБРАТЬ
		|						Таблица.Номенклатура,
		|						Таблица.СерийныйНомер,
		|						Таблица.Склад
		|					ИЗ
		|						ДвиженияДвиженияСерийныхНомеровИзменение КАК Таблица)
		|			И (НЕ ДвиженияСерийныхНомеров.АналитикаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.АналитикаХозяйственныхОпераций.ПогашениеПодарочныхСертификатов))
		|			И (НЕ ДвиженияСерийныхНомеров.Отправитель = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))) КАК ВложенныйЗапрос
		|	
		|	СГРУППИРОВАТЬ ПО
		|		ВложенныйЗапрос.Склад,
		|		ВложенныйЗапрос.СерийныйНомер,
		|		ВложенныйЗапрос.Номенклатура) КАК ВложенныйЗапрос
		|ГДЕ
		|	ВложенныйЗапрос.Количество < 0;
		|///////////////////////////////////////////////////////////////////
		|";

		
	КонецЕсли;
	
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц,"ДвиженияРасчетыСПоставщикамиИзменение") Тогда
		
		МассивКонтролей.Добавить(Врег("РасчетыСПоставщиками"));
		
		СписокДокументовВзаимозачета = Объект.ЭтапыОплат.ВыгрузитьКолонку("ДокументВзаимозачета");
		
		Индекс = СписокДокументовВзаимозачета.Количество() - 1;
		
		Пока Индекс >= 0 Цикл
			ДокументВзаимозачета = СписокДокументовВзаимозачета[Индекс];
			Если НЕ ЗначениеЗаполнено(ДокументВзаимозачета) Тогда
				СписокДокументовВзаимозачета.Удалить(Индекс);
			КонецЕсли;
			Индекс = Индекс - 1;
		КонецЦикла;
		
		ТекстЗапроса = ТекстЗапроса + "
		|ВЫБРАТЬ
		|	РасчетыСПоставщикамиОстатки.ДокументРасчета КАК ДокументВзаимозачета,
		|	-РасчетыСПоставщикамиОстатки.СуммаОстаток КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(, ДокументРасчета В (&СписокДокументовВзаимозачета)) КАК РасчетыСПоставщикамиОстатки
		|ГДЕ
		|	РасчетыСПоставщикамиОстатки.СуммаОстаток < 0;
		|///////////////////////////////////////////////////////////////////
		|";

		
		ПакетЗапросов.УстановитьПараметр("СписокДокументовВзаимозачета", СписокДокументовВзаимозачета);
		
	КонецЕсли;
	
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц,"ДвиженияДенежныеСредстваКВыплатеИзменение") Тогда
		
		МассивКонтролей.Добавить(Врег("ДенежныеСредстваКВыплате"));
		
		ТекстЗапроса = ТекстЗапроса + "
		|ВЫБРАТЬ
		|	ДенежныеСредстваКВыплатеОстатки.РаспоряжениеНаРасходованиеДенежныхСредств КАК РаспоряжениеНаРасходованиеДенежныхСредств,
		|	ДенежныеСредстваКВыплатеОстатки.СтатьяДвиженияДенежныхСредств             КАК СтатьяДвиженияДенежныхСредств,
		|	ДенежныеСредстваКВыплатеОстатки.ДокументРасчета                           КАК ДокументРасчета,
		|	ДенежныеСредстваКВыплатеОстатки.СуммаОстаток                              КАК Сумма
		|ИЗ
		|	РегистрНакопления.ДенежныеСредстваКВыплате.Остатки(
		|			,
		|			(РаспоряжениеНаРасходованиеДенежныхСредств, СтатьяДвиженияДенежныхСредств, ДокументРасчета) В
		|				(ВЫБРАТЬ
		|					Таблица.РаспоряжениеНаРасходованиеДенежныхСредств,
		|					Таблица.СтатьяДвиженияДенежныхСредств,
		|					Таблица.ДокументРасчета
		|				ИЗ
		|					ДвиженияДенежныеСредстваКВыплатеИзменение КАК Таблица)) КАК ДенежныеСредстваКВыплатеОстатки
		|ГДЕ
		|	ДенежныеСредстваКВыплатеОстатки.СуммаОстаток > 0;
		|///////////////////////////////////////////////////////////////////
		|";
		
		
	КонецЕсли;
	
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц, "ДвиженияДенежныеСредстваНаличныеИзменение") Тогда
		
		МассивКонтролей.Добавить(Врег("ДенежныеСредстваНаличные"));
		
		ТекстЗапроса = ТекстЗапроса + "ВЫБРАТЬ
		|	ДенежныеСредстваНаличныеОстатки.Организация КАК Организация,
		|	ДенежныеСредстваНаличныеОстатки.Магазин КАК Магазин,
		|	ДенежныеСредстваНаличныеОстатки.Касса КАК Касса,
		|	ДенежныеСредстваНаличныеОстатки.ДоговорПлатежногоАгента КАК ДоговорПлатежногоАгента,
		|	ДенежныеСредстваНаличныеОстатки.СуммаОстаток КАК СуммаОстаток
		|ИЗ
		|	РегистрНакопления.ДенежныеСредстваНаличные.Остатки(
		|			,
		|			(Организация, Магазин, Касса, ДоговорПлатежногоАгента) В
		|				(ВЫБРАТЬ
		|					Таблица.Организация,
		|					Таблица.Магазин,
		|					Таблица.Касса,
		|					Таблица.ДоговорПлатежногоАгента
		|				ИЗ
		|					ДвиженияДенежныеСредстваНаличныеИзменение КАК Таблица)) КАК ДенежныеСредстваНаличныеОстатки
		|ГДЕ
		|	ДенежныеСредстваНаличныеОстатки.СуммаОстаток < 0
		|;
		|///////////////////////////////////////////////////////////////////
		|";
		
		
	КонецЕсли;
	
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц, "ДвиженияДенежныеСредстваККМИзменение") Тогда
		
		МассивКонтролей.Добавить(Врег("ДенежныеСредстваККМ"));
		
		ТекстЗапроса = ТекстЗапроса + "ВЫБРАТЬ
		|	ДенежныеСредстваККМОстатки.КассаККМ КАК КассаККМ,
		|	ДенежныеСредстваККМОстатки.ДоговорПлатежногоАгента КАК ДоговорПлатежногоАгента,
		|	ДенежныеСредстваККМОстатки.СуммаОстаток КАК СуммаОстаток
		|ИЗ
		|	РегистрНакопления.ДенежныеСредстваККМ.Остатки(
		|			,
		|			(КассаККМ, ДоговорПлатежногоАгента) В
		|				(ВЫБРАТЬ
		|					Таблица.КассаККМ,
		|					Таблица.ДоговорПлатежногоАгента
		|				ИЗ
		|					ДвиженияДенежныеСредстваККМИзменение КАК Таблица)) КАК ДенежныеСредстваККМОстатки
		|ГДЕ
		|	ДенежныеСредстваККМОстатки.СуммаОстаток < 0
		|;
		|///////////////////////////////////////////////////////////////////
		|";
		
	КонецЕсли;
	
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц,"ДвиженияЗаказыПокупателейИзменение") Тогда

		МассивКонтролей.Добавить(Врег("ЗаказыПокупателей"));
		ТекстЗапроса = ТекстЗапроса + "
		|ВЫБРАТЬ
		|	ЗаказыПокупателейОстатки.Номенклатура КАК Номенклатура,
		|	ЗаказыПокупателейОстатки.Характеристика КАК Характеристика,
		|	ЗаказыПокупателейОстатки.Магазин КАК Магазин,
		|	ЗаказыПокупателейОстатки.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	ЗаказыПокупателейОстатки.Заказ КАК Заказ,
		|	ЗаказыПокупателейОстатки.КодСтроки КАК КодСтроки,
		|	ЗаказыПокупателейОстатки.ЗаказаноОстаток КАК Заказано
		|ИЗ
		|	РегистрНакопления.ЗаказыПокупателей.Остатки(
		|			,
		|			(Номенклатура, Характеристика, Магазин, Заказ, КодСтроки) В
		|				(ВЫБРАТЬ
		|					Таблица.Номенклатура,
		|					Таблица.Характеристика,
		|					Таблица.Магазин,
		|					Таблица.Заказ,
		|					Таблица.КодСтроки
		|				ИЗ
		|					ДвиженияЗаказыПокупателейИзменение КАК Таблица)) КАК ЗаказыПокупателейОстатки
		|ГДЕ
		|	ЗаказыПокупателейОстатки.ЗаказаноОстаток < 0;
		|///////////////////////////////////////////////////////////////////
		|";
		
	КонецЕсли;
	
	Если ЕстьИзмененияВТаблице(ДанныеТаблиц,"ДвиженияТоварыОрганизацийИзменение") Тогда
		
		МассивКонтролей.Добавить(Врег("ТоварыОрганизаций"));
		ТекстЗапроса = ТекстЗапроса 
		+ "ВЫБРАТЬ
		|	ТоварыОрганизацийОстатки.Номенклатура                  КАК Номенклатура,
		|	ТоварыОрганизацийОстатки.Характеристика                КАК Характеристика,
		|	ТоварыОрганизацийОстатки.Склад                         КАК Склад,
		|	ТоварыОрганизацийОстатки.Организация                   КАК Организация,
		|	ТоварыОрганизацийОстатки.Поставщик                     КАК Поставщик,
		|	ТоварыОрганизацийОстатки.Договор                       КАК Договор,
		|	ТоварыОрганизацийОстатки.НомерГТД                      КАК НомерГТД,
		|	ТоварыОрганизацийОстатки.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	ТоварыОрганизацийОстатки.КоличествоОстаток             КАК Количество
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций.Остатки(
		|			,
		|			(Номенклатура, Характеристика, Склад, Организация, Поставщик, Договор, НомерГТД) В
		|				(ВЫБРАТЬ
		|					Таблица.Номенклатура,
		|					Таблица.Характеристика,
		|					Таблица.Склад,
		|					Таблица.Организация,
		|					Таблица.Поставщик,
		|					Таблица.Договор,
		|					Таблица.НомерГТД
		|				ИЗ
		|					ДвиженияТоварыОрганизацийИзменение КАК Таблица
		|				ГДЕ
		|					Таблица.Договор <> &ПустойДоговор
		|					ИЛИ Таблица.НомерГТД <> &ПустойГТД)) КАК ТоварыОрганизацийОстатки
		|ГДЕ
		|	ТоварыОрганизацийОстатки.КоличествоОстаток < 0
		|;
		|///////////////////////////////////////////////////////////////////
		|";
		ПакетЗапросов.УстановитьПараметр("ПустойДоговор", Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка());
		ПакетЗапросов.УстановитьПараметр("ПустойГТД", Справочники.НомераГТД.ПустаяСсылка());
		
	КонецЕсли;
	
	Если МассивКонтролей.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	ПакетЗапросов.Текст = ТекстЗапроса;
	ПакетЗапросов.МенеджерВременныхТаблиц = ДанныеТаблиц.МенеджерВременныхТаблиц;
	МассивРезультатов = ПакетЗапросов.ВыполнитьПакет();
	Итератор = -1;
	Для Каждого Результат Из МассивРезультатов Цикл

		Итератор = Итератор + 1;
		Если Результат.Пустой() Тогда
			
			Продолжить;
			
		КонецЕсли;

		ИмяКонтроля = МассивКонтролей[Итератор];

		Если ИмяКонтроля = Врег("ТоварыНаСкладах") Тогда

			СообщитьОбОшибкахПроведенияПоРегиструТоварыНаСкладах(Объект, Отказ, Результат);
			
			ФиксироватьПопыткиПродажПревышающихОстаток(Объект, Объект.Дата, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("ДвиженияСерийныхНомеров") Тогда

			СообщитьОбОшибкахПроведенияПоРегиструДвиженияСерийныхНомеров(Объект, Отказ, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("РасчетыСПоставщиками") Тогда
		
			СообщитьОбОшибкахПроведенияПоРегиструРасчетыСПоставщиками(Объект, Отказ, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("ДенежныеСредстваКВыплате") Тогда
		
			СообщитьОбОшибкахПроведенияПоРегиструДенежныеСредстваКВыплате(Объект, Отказ, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("ДенежныеСредстваНаличные") Тогда
		
			СообщитьОбОшибкахПроведенияПоРегиструДенежныеСредстваНаличные(Объект, Отказ, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("ДенежныеСредстваККМ") Тогда
		
			СообщитьОбОшибкахПроведенияПоРегиструДенежныеСредстваККМ(Объект, Отказ, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("ЗаказыПокупателей") Тогда
			
			СообщитьОбОшибкахПроведенияПоРегиструЗаказыПокупателей(Объект, Отказ, Результат);
			
		ИначеЕсли ИмяКонтроля = Врег("ТоварыОрганизаций") Тогда
			
			СообщитьОбОшибкахПроведенияПоРегиструТоварыОрганизаций(Объект, Отказ, Результат);
			
		Иначе
			
			ВызватьИсключение НСтр("ru = 'Ошибка контроля проведения!'");
			
		КонецЕсли;
		
	КонецЦикла;

	Если Отказ Тогда

		Если Объект.ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
			
			ТекстСообщения = НСтр("ru = 'Проведение не выполнено'");
			
		Иначе
			
			ТекстСообщения = НСтр("ru = 'Отмена проведения не выполнена'");
			
		КонецЕсли;

		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения + ": " + Строка(Объект), Объект);

	КонецЕсли;

КонецПроцедуры

// Процедуры выдачи сообщений об ошибках проведения.
//
Процедура СообщитьОбОшибкахПроведенияПоРегиструТоварыНаСкладах(Объект, Отказ, РезультатЗапроса)

	ШаблонСообщения = НСтр("ru = 'Номенклатура %1 
		|Превышен остаток на складе %2 на %3 %4'");
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьРезервированиеПоЗаказамПокупателей") Тогда
		ШаблонСообщения = НСтр("ru = 'Номенклатура %1 
			|Превышен сводобный остаток на складе %2 на %3 %4'");
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонСообщения,
			ФормированиеПечатныхФормСервер.ПолучитьПредставлениеНоменклатурыДляПечати(Выборка.Номенклатура, Выборка.Характеристика),
			Строка(Выборка.Склад),
			Строка(-Выборка.Количество),
			Строка(Выборка.ЕдиницаИзмерения));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,Объект,,,Отказ);

	КонецЦикла;

КонецПроцедуры

// Процедуры выдачи сообщений об ошибках проведения.
//
Процедура СообщитьОбОшибкахПроведенияПоРегиструЗаказыПокупателей(Объект, Отказ, РезультатЗапроса)

	ШаблонСообщения = НСтр("ru = 'Номенклатура %1 
		|Превышен остаток по заказу %2 по строке с кодом %3 в магазине %4 на %5 %6'");
		

	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонСообщения,
			ФормированиеПечатныхФормСервер.ПолучитьПредставлениеНоменклатурыДляПечати(Выборка.Номенклатура, Выборка.Характеристика),
			Строка(Выборка.Заказ),
			Строка(Выборка.КодСтроки),
			Строка(Выборка.Магазин),
			Строка(-Выборка.Заказано),
			Строка(Выборка.ЕдиницаИзмерения));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,Объект,,,Отказ);

	КонецЦикла;

КонецПроцедуры

// Процедуры выдачи сообщений об ошибках проведения.
//
Процедура СообщитьОбОшибкахПроведенияПоРегиструДвиженияСерийныхНомеров(Объект, Отказ, РезультатЗапроса)

	ШаблонСообщенияНоменклатуры = НСтр("ru = 'Номенклатура %1 
		|Превышен остаток серийных номеров на складе %2 на %3 %4'");

	ШаблонСообщенияСертификат = НСтр("ru = 'Номер подарочного сертификата %5 (%1)
		|Превышен остаток серийных номеров на складе %2 на %3 %4'");
		
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Если ЗначениеЗаполнено(Выборка.СерийныйНомер) Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонСообщенияСертификат,
				Выборка.Номенклатура,
				Строка(Выборка.Склад),
				Строка(-Выборка.Количество),
				Строка(Выборка.ЕдиницаИзмерения),
				Выборка.СерийныйНомер);
		Иначе
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				ШаблонСообщенияНоменклатуры,
				Выборка.Номенклатура,
				Строка(Выборка.Склад),
				Строка(-Выборка.Количество),
				Строка(Выборка.ЕдиницаИзмерения),
				Выборка.СерийныйНомер);
		КонецЕсли;
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,Объект,,,Отказ);

	КонецЦикла;

КонецПроцедуры

Процедура СообщитьОбОшибкахПроведенияПоРегиструРасчетыСПоставщиками(Объект, Отказ, РезультатЗапроса)
	
	ШаблонСообщения = НСтр("ru = 'Превышена на %1 руб. доступная сумма взаимозачета по документу %2 списка ""Этапы оплат""'");
		
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ШаблонСообщения,
		Выборка.Сумма,
		Строка(Выборка.ДокументВзаимозачета));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,Объект,,,Отказ);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СообщитьОбОшибкахПроведенияПоРегиструДенежныеСредстваКВыплате(Объект, Отказ, РезультатЗапроса)
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Если Объект.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПрочиеРасходы Тогда
		
		ШаблонСообщения = НСтр("ru = 'Превышена на %1 руб. утвержденная сумма оплаты по статье ""%2""'");
		КолонкаВыборки = "СтатьяДвиженияДенежныхСредств";
		
	Иначе
		
		ШаблонСообщения = НСтр("ru = 'Превышена на %1 руб. утвержденная сумма оплаты по документу ""%2""'");
		КолонкаВыборки = "ДокументРасчета";
		
	КонецЕсли;
	
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ШаблонСообщения,
		Выборка.Сумма,
		Строка(Выборка[КолонкаВыборки]));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,Объект,,,Отказ);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СообщитьОбОшибкахПроведенияПоРегиструДенежныеСредстваНаличные(Объект, Отказ, РезультатЗапроса)
	
	Выборка = РезультатЗапроса.Выбрать();
	
	ИспользоватьАгентскиеПлатежиИРазделениеВыручки = ПолучитьФункциональнуюОпцию("ИспользоватьАгентскиеПлатежиИРазделениеВыручки");
	Если ИспользоватьАгентскиеПлатежиИРазделениеВыручки Тогда
		ШаблонСообщения = НСтр("ru = 'Превышен на %1 руб. остаток наличных денежных средств в кассе ""%2"" по типу выручки ""%3""'");
	Иначе
		ШаблонСообщения = НСтр("ru = 'Превышен на %1 руб. остаток наличных денежных средств в кассе ""%2""'");
	КонецЕсли;
	
	Пока Выборка.Следующий() Цикл
		
		Если ИспользоватьАгентскиеПлатежиИРазделениеВыручки Тогда
			ТипВыручки = Выборка.ДоговорПлатежногоАгента;
			Если ТипВыручки = Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка() Тогда
				ТипВыручки = НСтр("ru = 'Собственные средства'");
			КонецЕсли;
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								ШаблонСообщения,
								- Выборка.СуммаОстаток,
								Выборка.Касса,
								ТипВыручки);
		Иначе
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								ШаблонСообщения,
								- Выборка.СуммаОстаток,
								Выборка.Касса);
		КонецЕсли;
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Объект, , , Отказ);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СообщитьОбОшибкахПроведенияПоРегиструДенежныеСредстваККМ(Объект, Отказ, РезультатЗапроса)
	
	Выборка = РезультатЗапроса.Выбрать();
	
	ИспользоватьАгентскиеПлатежиИРазделениеВыручки = ПолучитьФункциональнуюОпцию("ИспользоватьАгентскиеПлатежиИРазделениеВыручки");
	Если ИспользоватьАгентскиеПлатежиИРазделениеВыручки Тогда
		ШаблонСообщения = НСтр("ru = 'Превышен на %1 руб. остаток денежных средств в кассе ККМ ""%2"" по типу выручки ""%3""'");
	Иначе
		ШаблонСообщения = НСтр("ru = 'Превышен на %1 руб. остаток денежных средств в кассе ККМ ""%2""'");
	КонецЕсли;
	
	Пока Выборка.Следующий() Цикл
		
		Если ИспользоватьАгентскиеПлатежиИРазделениеВыручки Тогда
			ТипВыручки = Выборка.ДоговорПлатежногоАгента;
			Если ТипВыручки = Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка() Тогда
				ТипВыручки = НСтр("ru = 'Собственные средства'");
			КонецЕсли;
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								ШаблонСообщения,
								- Выборка.СуммаОстаток,
								Выборка.КассаККМ,
								ТипВыручки);
		Иначе
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								ШаблонСообщения,
								- Выборка.СуммаОстаток,
								Выборка.КассаККМ);
		КонецЕсли;
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Объект, , , Отказ);
		
	КонецЦикла;
	
КонецПроцедуры

// Процедуры выдачи сообщений об ошибках проведения.
//
Процедура СообщитьОбОшибкахПроведенияПоРегиструТоварыОрганизаций(Объект, Отказ, РезультатЗапроса)

	ШаблонСообщения = НСтр("ru = 'Номенклатура %1 
		|Превышен остаток по организации %2 на %3 %4'");
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьРезервированиеПоЗаказамПокупателей") Тогда
		ШаблонСообщения = НСтр("ru = 'Номенклатура %1 
			|Превышен сводобный остаток по организации %2 на %3 %4'");
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонСообщения,
			ФормированиеПечатныхФормСервер.ПолучитьПредставлениеНоменклатурыДляПечати(Выборка.Номенклатура, Выборка.Характеристика),
			Строка(Выборка.Организация),
			Строка(-Выборка.Количество),
			Строка(Выборка.ЕдиницаИзмерения));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,Объект,,,Отказ);

	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ПрочиеПроцедуры

// Функция вызывается из модулей наборов записей для проверки необходимости
// контроля изменений движений в регистре.
//
Функция РассчитыватьИзменения(ДополнительныеСвойстваНабораЗаписей) Экспорт
	Перем РассчитыватьИзменения;

	Возврат ДополнительныеСвойстваНабораЗаписей.Свойство("РассчитыватьИзменения", РассчитыватьИзменения)
		И РассчитыватьИзменения;

КонецФункции

// Процедура формирует запрос по временной таблице.
//
// Параметры:
//  СтруктураШапкиДокумента - Структура - Реквизиты документа "Расчет себестоимости выпуска".
//	МенеджерВременныхТаблиц - МенеджерВременныхТаблиц
//	ИмяВременнойТаблицы - Строка - Имя временной таблицы.
//
Процедура ПоказатьВременнуюТаблицу(МенеджерВременныхТаблиц,ИмяВременнойТаблицы, Комментарий = "") Экспорт

	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	*
	|ИЗ
	|	ИмяВременнойТаблицы
	|";
	
	Запрос = Новый Запрос;
	Запрос.Текст = СтрЗаменить(ТекстЗапроса, "ИмяВременнойТаблицы", ИмяВременнойТаблицы);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	РезультатЗапроса = Запрос.Выполнить().Выгрузить().ВыбратьСтроку(ИмяВременнойТаблицы + ":" + Комментарий);
	
КонецПроцедуры // ПоказатьВременнуюТаблицу()

// Процедура заполнения таблицы попытки продажи превыщающих остатки
//
Процедура ФиксироватьПопыткиПродажПревышающихОстаток(Объект, ДатаПродажи, Результат) Экспорт
	
	Если ПолучитьФункциональнуюОпцию("ФиксироватьПопыткиПродажПревышающихОстаток") 
		И Объект.ДополнительныеСвойства.ДляПроведения.Свойство("ПопыткиПродажПревышающихОстаток") Тогда
		
		ТаблицаОтрицательныхОстатков = Результат.Выгрузить();
		ТаблицаОтрицательныхОстатков.Колонки.Добавить("ДатаПродажи", Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.Дата)));
		
		ТаблицаОтрицательныхОстатков.ЗаполнитьЗначения(НачалоДня(ДатаПродажи),"ДатаПродажи");
		
		Объект.ДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаПопыткиПродажПревышающихОстаток", ТаблицаОтрицательныхОстатков.Скопировать(,"ДатаПродажи,Склад,Номенклатура,Характеристика"));
		
	КонецЕсли;
	
КонецПроцедуры

// Процедура установки режима проведения
//
Процедура УстановитьРежимПроведения(Проведен, РежимЗаписи, РежимПроведения) Экспорт

	Если Проведен И РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		РежимПроведения = РежимПроведенияДокумента.Неоперативный;
	КонецЕсли;

КонецПроцедуры

// Процедура добавляет в движения документа данные для регистра ДействиеСкидокНаценок.
//
Процедура ОтразитьПлощадьТорговогоПространства(ДополнительныеСвойства, Движения, Отказ) Экспорт

	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПлощадьТорговогоПространства;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	Движения.ПлощадьТорговогоПространства.Записывать = Истина;
	Движения.ПлощадьТорговогоПространства.Загрузить(Таблица);
	
КонецПроцедуры

// Процедура дозаполняет таблицу товаров для регистра по организациям
//
// Параметры
//  ДокументСсылка - Ссылка на документ расхода - документ основание.
//  ТаблицаТоварыОрганизаций - Таблица значений
//  Период - Дата и время документа из ДокументСсылка
//
Процедура ЗаполнитьТаблицуДвиженийПриходаРегистраТоварыОрганизаций(ДокументОснованиеСсылка, ТаблицаТоварыОрганизаций, Период) Экспорт
	
	ПриоритетыРеализацииТоваров = Константы.ПриоритетыРеализацииТоваров.Получить();
	ПриоритетКомиссионного = ПриоритетыРеализацииТоваров = Перечисления.ПриоритетыРеализацииТоваров.Комиссионный;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	&Период КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТоварыОрганизаций.Номенклатура КАК Номенклатура,
	|	ТоварыОрганизаций.Характеристика КАК Характеристика,
	|	ТоварыОрганизаций.Склад КАК Склад,
	|	ТоварыОрганизаций.Организация КАК Организация,
	|	ТоварыОрганизаций.Поставщик КАК Поставщик,
	|	ТоварыОрганизаций.Договор КАК Договор,
	|	ТоварыОрганизаций.НомерГТД КАК НомерГТД,
	|	ТоварыОрганизаций.Количество КАК Количество,
	|	ТоварыОрганизаций.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|ГДЕ
	|	ТоварыОрганизаций.Регистратор = &Регистратор
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки УБЫВ";
	
	
	Запрос.УстановитьПараметр("Период", Период);
	Запрос.УстановитьПараметр("Регистратор", ДокументОснованиеСсылка);
	Результат = Запрос.Выполнить();
	ТаблицаДаижений = Результат.Выгрузить();
	ИтоговаяТаблица = ТаблицаТоварыОрганизаций.Скопировать();
	ИтоговаяТаблица.Очистить();
	
	ИтоговаяТаблица.Колонки.Добавить("НомерСтрокиДокумента", Новый ОписаниеТипов("Число"));

	Для Каждого СтрокаТаблицы Из ТаблицаТоварыОрганизаций Цикл
		
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Номенклатура"  , СтрокаТаблицы.Номенклатура);
		СтруктураПоиска.Вставить("Характеристика", СтрокаТаблицы.Характеристика);
		СтруктураПоиска.Вставить("Организация"   , СтрокаТаблицы.Организация);
		СтруктураПоиска.Вставить("Склад"         , СтрокаТаблицы.Склад);
		
		СтрокиДвижений = ТаблицаДаижений.НайтиСтроки(СтруктураПоиска);
		ПодбираемоеКоличество = СтрокаТаблицы.Количество;
		МассивУдаляемыхСтрок = Новый Массив;
		
		СуммаПродажи = СтрокаТаблицы.СуммаПродажи;
		ОстатокСуммыПродажи = СуммаПродажи;
		СтрокаСМаксимальнойСуммой = Неопределено;
		МаксимальнаяСуммаПродажи = 0;
		
		ОбщееКоличество = СтрокаТаблицы.Количество;
		
		Для Каждого СтрокаДвижений Из СтрокиДвижений Цикл
			
			СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаДвижений);
			Если ПодбираемоеКоличество >= СтрокаДвижений.Количество Тогда
				МассивУдаляемыхСтрок.Добавить(СтрокаДвижений);
				ПодбираемоеКоличество = ПодбираемоеКоличество - СтрокаДвижений.Количество;
			Иначе
				СтрокаИтоговойТаблицы.Количество = ПодбираемоеКоличество;
				СтрокаДвижений.Количество = СтрокаДвижений.Количество - СтрокаИтоговойТаблицы.Количество;
				ПодбираемоеКоличество = 0;
			КонецЕсли;
			
			СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаТаблицы.НомерСтроки;
			Если СуммаПродажи <> 0
				И ОбщееКоличество <> 0
				И СтрокаИтоговойТаблицы.Количество <> ОбщееКоличество Тогда
				
				СтрокаИтоговойТаблицы.СуммаПродажи = СуммаПродажи * СтрокаИтоговойТаблицы.Количество / ОбщееКоличество;
				Если СтрокаИтоговойТаблицы.СуммаПродажи > МаксимальнаяСуммаПродажи Тогда
					МаксимальнаяСуммаПродажи = СтрокаИтоговойТаблицы.СуммаПродажи;
					СтрокаСМаксимальнойСуммой = СтрокаИтоговойТаблицы;
				КонецЕсли;
				ОстатокСуммыПродажи = ОстатокСуммыПродажи - СтрокаИтоговойТаблицы.СуммаПродажи;
			КонецЕсли;
			
			Если ПодбираемоеКоличество <= 0 Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого УдаляемаяСтрока Из МассивУдаляемыхСтрок Цикл
			ТаблицаДаижений.Удалить(УдаляемаяСтрока);
		КонецЦикла;
	КонецЦикла;
	
	ТаблицаТоварыОрганизаций = ИтоговаяТаблица;
	
КонецПроцедуры

// Процедура дозаполняет таблицу товаров для регистра по организациям,
// по документам в табличной части
//
// Параметры
//  ТаблицаТоварыОрганизаций - Таблица значений
//  Период - Дата и время документа из ДокументСсылка
//
Процедура ЗаполнитьТаблицуДвиженийПриходаРегистраТоварыОрганизацийИзТЧ(ТаблицаТоварыОрганизаций, Период) Экспорт
	
	ПриоритетыРеализацииТоваров = Константы.ПриоритетыРеализацииТоваров.Получить();
	ПриоритетКомиссионного = ПриоритетыРеализацииТоваров = Перечисления.ПриоритетыРеализацииТоваров.Комиссионный;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	&Период КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТоварыОрганизаций.Номенклатура КАК Номенклатура,
	|	ТоварыОрганизаций.Характеристика КАК Характеристика,
	|	ТоварыОрганизаций.Склад КАК Склад,
	|	ТоварыОрганизаций.Организация КАК Организация,
	|	ТоварыОрганизаций.Регистратор КАК ДокументПродажи,
	|	ТоварыОрганизаций.Поставщик КАК Поставщик,
	|	ТоварыОрганизаций.Договор КАК Договор,
	|	ТоварыОрганизаций.НомерГТД КАК НомерГТД,
	|	ТоварыОрганизаций.Количество КАК Количество,
	|	ТоварыОрганизаций.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|ГДЕ
	|	ТоварыОрганизаций.Регистратор В (&Регистраторы)
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки УБЫВ";
	
	Запрос.УстановитьПараметр("Период", Период);
	Запрос.УстановитьПараметр("Регистраторы", ТаблицаТоварыОрганизаций.ВыгрузитьКолонку("ДокументПродажи"));
	
	Результат = Запрос.Выполнить();
	ТаблицаДаижений = Результат.Выгрузить();
	ИтоговаяТаблица = ТаблицаТоварыОрганизаций.Скопировать();
	ИтоговаяТаблица.Очистить();
	
	ИтоговаяТаблица.Колонки.Добавить("НомерСтрокиДокумента", Новый ОписаниеТипов("Число"));

	Для Каждого СтрокаТаблицы Из ТаблицаТоварыОрганизаций Цикл
		
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Номенклатура"   , СтрокаТаблицы.Номенклатура);
		СтруктураПоиска.Вставить("Характеристика" , СтрокаТаблицы.Характеристика);
		СтруктураПоиска.Вставить("Организация"    , СтрокаТаблицы.Организация);
		СтруктураПоиска.Вставить("Склад"          , СтрокаТаблицы.Склад);
		СтруктураПоиска.Вставить("ДокументПродажи", СтрокаТаблицы.ДокументПродажи);
		
		СтрокиДвижений = ТаблицаДаижений.НайтиСтроки(СтруктураПоиска);
		ПодбираемоеКоличество = СтрокаТаблицы.Количество;
		МассивУдаляемыхСтрок = Новый Массив;
		
		СуммаПродажи = СтрокаТаблицы.СуммаПродажи;
		ОстатокСуммыПродажи = СуммаПродажи;
		СтрокаСМаксимальнойСуммой = Неопределено;
		МаксимальнаяСуммаПродажи = 0;
		
		ОбщееКоличество = СтрокаТаблицы.Количество;
		
		Для Каждого СтрокаДвижений Из СтрокиДвижений Цикл
			
			СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаДвижений);
			Если ПодбираемоеКоличество >= СтрокаДвижений.Количество Тогда
				МассивУдаляемыхСтрок.Добавить(СтрокаДвижений);
				ПодбираемоеКоличество = ПодбираемоеКоличество - СтрокаДвижений.Количество;
			Иначе
				СтрокаИтоговойТаблицы.Количество = ПодбираемоеКоличество;
				СтрокаДвижений.Количество = СтрокаДвижений.Количество - СтрокаИтоговойТаблицы.Количество;
				ПодбираемоеКоличество = 0;
			КонецЕсли;
			
			СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаТаблицы.НомерСтроки;
			Если СуммаПродажи <> 0
				И ОбщееКоличество <> 0
				И СтрокаИтоговойТаблицы.Количество <> ОбщееКоличество Тогда
				
				СтрокаИтоговойТаблицы.СуммаПродажи = СуммаПродажи * СтрокаИтоговойТаблицы.Количество / ОбщееКоличество;
				Если СтрокаИтоговойТаблицы.СуммаПродажи > МаксимальнаяСуммаПродажи Тогда
					МаксимальнаяСуммаПродажи = СтрокаИтоговойТаблицы.СуммаПродажи;
					СтрокаСМаксимальнойСуммой = СтрокаИтоговойТаблицы;
				КонецЕсли;
				ОстатокСуммыПродажи = ОстатокСуммыПродажи - СтрокаИтоговойТаблицы.СуммаПродажи;
			КонецЕсли;
			
			Если ПодбираемоеКоличество <= 0 Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого УдаляемаяСтрока Из МассивУдаляемыхСтрок Цикл
			ТаблицаДаижений.Удалить(УдаляемаяСтрока);
		КонецЦикла;
	КонецЦикла;
	
	ТаблицаТоварыОрганизаций = ИтоговаяТаблица;
	
КонецПроцедуры

// Функция заполняет таблицу товаров для регистра товары у оформлению отчетов
//
// Параметры
//  ТаблицаТоварыОрганизаций - Таблица значений, поля см. регистр "ТоварыОрганизаций"
//  СсылкадДокумента - ДокументСсылка - регистратор см. регистр "ТоварыОрганизаций"
//
// Возвращаемое значение
//  ТаблицыЗначений
//
Функция ТаблицаДвиженийРегистраТоварыКОформлениюОтчетовКомитенту(Знач ТаблицаТоварыОрганизаций, ВидДвиженияПриход = Истина) Экспорт
	
	ВозвращаемаяТаблица = ТаблицаТоварыОрганизаций.Скопировать();
	СтруктураПоиска = Новый Структура;
	СтруктураПоиска.Вставить("Договор", Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка());
	
	СтрокиТаблицы = ВозвращаемаяТаблица.НайтиСтроки(СтруктураПоиска);
	
	Для каждого СтрокаТаблицы Из СтрокиТаблицы Цикл
		
		ВозвращаемаяТаблица.Удалить(СтрокаТаблицы)
		
	КонецЦикла;
	
	Для каждого СтрокаТаблицы Из ВозвращаемаяТаблица Цикл
		Если СтрокаТаблицы.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
			СтрокаТаблицы.ВидДвижения = ВидДвиженияНакопления.Расход
		Иначе
			СтрокаТаблицы.ВидДвижения = ВидДвиженияНакопления.Приход
		КонецЕсли;
	КонецЦикла;
	
	Возврат ВозвращаемаяТаблица
КонецФункции

Процедура ПерезаполнитьТаблицуДвиженийТоварыОрганизаций(ТаблицаТоварыОрганизаций, ДокументСсылка, Период, ЕстьДанныеДляОтчетаКомитенту = Ложь, ПриходныеДвиженияОставлятьБезИзменений = Ложь) Экспорт
	
	ТаблицаОстатков = ТаблицаОстатковОрганизаций(ТаблицаТоварыОрганизаций, ДокументСсылка, Период);
	
	ИтоговаяТаблица = ТаблицаТоварыОрганизаций.Скопировать();
	ИтоговаяТаблица.Очистить();
	
	Если ИтоговаяТаблица.Колонки.Найти("НомерСтрокиДокумента") = Неопределено Тогда
		ИтоговаяТаблица.Колонки.Добавить("НомерСтрокиДокумента", Новый ОписаниеТипов("Число"));
	КонецЕсли;
	
	ПустойПоставшик = Справочники.Контрагенты.ПустаяСсылка();
	ПустойДоговор = Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка();
	
	Для Каждого СтрокаТаблицы Из ТаблицаТоварыОрганизаций Цикл
		
		Если СтрокаТаблицы.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
			
			Если ПриходныеДвиженияОставлятьБезИзменений Тогда
				СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаТаблицы);
				СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаТаблицы.НомерСтроки;
			Иначе
				СтруктураПоиска = Новый Структура;
				СтруктураПоиска.Вставить("НомерСтроки", СтрокаТаблицы.НомерСтроки);
				СтрокиРасхода = ИтоговаяТаблица.НайтиСтроки(СтруктураПоиска);
				Если СтрокиРасхода.Количество() > 0 Тогда
					Для Каждого СтрокаРасхода Из СтрокиРасхода Цикл
						СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
						ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаРасхода);
						СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаРасхода.НомерСтроки;
						СтрокаИтоговойТаблицы.ВидДвижения = ВидДвиженияНакопления.Приход;
						СтрокаИтоговойТаблицы.Склад = СтрокаТаблицы.Склад;
						Если СтрокаИтоговойТаблицы.Организация <> СтрокаТаблицы.Организация Тогда
							СтрокаИтоговойТаблицы.Организация = СтрокаТаблицы.Организация;
							СтрокаИтоговойТаблицы.Поставщик = ПустойПоставшик;
							СтрокаИтоговойТаблицы.Договор = ПустойДоговор;
							Если НЕ ЕстьДанныеДляОтчетаКомитенту Тогда
								ЕстьДанныеДляОтчетаКомитенту = ЗначениеЗаполнено(СтрокаРасхода.Договор);
							КонецЕсли;
						КонецЕсли;
						СтрокаИтоговойТаблицы.ОрганизацияОтгрузки = Справочники.Организации.ПустаяСсылка();
					КонецЦикла;
				Иначе
					СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
					ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаТаблицы);
					СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаТаблицы.НомерСтроки;
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			
			СтруктураПоиска = Новый Структура;
			СтруктураПоиска.Вставить("Номенклатура"  , СтрокаТаблицы.Номенклатура);
			СтруктураПоиска.Вставить("Характеристика", СтрокаТаблицы.Характеристика);
			СтруктураПоиска.Вставить("Организация"   , СтрокаТаблицы.Организация);
			СтруктураПоиска.Вставить("Склад"         , СтрокаТаблицы.Склад);
			
			СтрокиОстатков = ТаблицаОстатков.НайтиСтроки(СтруктураПоиска);
			ПодбираемоеКоличество = СтрокаТаблицы.Количество;
			МассивУдаляемыхСтрок = Новый Массив;
			
			СуммаПродажи = СтрокаТаблицы.СуммаПродажи;
			ОстатокСуммыПродажи = СуммаПродажи;
			СтрокаСМаксимальнойСуммой = Неопределено;
			СтрокаСМаксимальнойСуммойБезДоговора = Неопределено;
			МаксимальнаяСуммаПродажи = 0;
			МаксимальнаяСуммаПродажиБезДоговора = 0;
			
			ОбщееКоличество = СтрокаТаблицы.Количество;
			
			Для Каждого СтрокаОстатков Из СтрокиОстатков Цикл
				
				СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаОстатков);
				Если ПодбираемоеКоличество >= СтрокаОстатков.Количество Тогда
					МассивУдаляемыхСтрок.Добавить(СтрокаОстатков);
					ПодбираемоеКоличество = ПодбираемоеКоличество - СтрокаОстатков.Количество;
				Иначе
					СтрокаИтоговойТаблицы.Количество = ПодбираемоеКоличество;
					СтрокаОстатков.Количество = СтрокаОстатков.Количество - СтрокаИтоговойТаблицы.Количество;
					ПодбираемоеКоличество = 0;
				КонецЕсли;
				
				СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаТаблицы.НомерСтроки;
				СтрокаИтоговойТаблицы.НомерСтроки = СтрокаТаблицы.НомерСтроки;
					
				Если СуммаПродажи <> 0 И ОбщееКоличество <> 0 Тогда
					Если СтрокаИтоговойТаблицы.Количество = ОбщееКоличество Тогда
						СтрокаИтоговойТаблицы.СуммаПродажи = СуммаПродажи;
					Иначе
						СтрокаИтоговойТаблицы.СуммаПродажи = СуммаПродажи * СтрокаИтоговойТаблицы.Количество / ОбщееКоличество;
					КонецЕсли;
					
					Если СтрокаИтоговойТаблицы.СуммаПродажи > МаксимальнаяСуммаПродажи Тогда
						МаксимальнаяСуммаПродажи = СтрокаИтоговойТаблицы.СуммаПродажи;
						СтрокаСМаксимальнойСуммой = СтрокаИтоговойТаблицы;
					КонецЕсли;
					Если СтрокаИтоговойТаблицы.СуммаПродажи > МаксимальнаяСуммаПродажиБезДоговора Тогда
						Если НЕ ЗначениеЗаполнено(СтрокаИтоговойТаблицы.Договор) Тогда
							МаксимальнаяСуммаПродажиБезДоговора = СтрокаИтоговойТаблицы.СуммаПродажи;
							СтрокаСМаксимальнойСуммойБезДоговора = СтрокаИтоговойТаблицы;
						КонецЕсли;
					КонецЕсли;
					ОстатокСуммыПродажи = ОстатокСуммыПродажи - СтрокаИтоговойТаблицы.СуммаПродажи;
				КонецЕсли;
				
				Если ПодбираемоеКоличество = 0 Тогда
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
			Для Каждого УдаляемаяСтрока Из МассивУдаляемыхСтрок Цикл
				ТаблицаОстатков.Удалить(УдаляемаяСтрока);
			КонецЦикла;
			
			Если ПодбираемоеКоличество > 0 Тогда
				СтрокаИтоговойТаблицы = ИтоговаяТаблица.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаИтоговойТаблицы, СтрокаТаблицы);
				СтрокаИтоговойТаблицы.Количество = ПодбираемоеКоличество;
				СтрокаИтоговойТаблицы.НомерСтрокиДокумента = СтрокаТаблицы.НомерСтроки;
				
				Если СуммаПродажи <> 0 И ОбщееКоличество <> 0 Тогда
					Если СтрокаИтоговойТаблицы.Количество = ОбщееКоличество Тогда
						СтрокаИтоговойТаблицы.СуммаПродажи = СуммаПродажи;
					Иначе
						СтрокаИтоговойТаблицы.СуммаПродажи = СуммаПродажи * СтрокаИтоговойТаблицы.Количество / ОбщееКоличество;
					КонецЕсли;
					
					Если СтрокаИтоговойТаблицы.СуммаПродажи > МаксимальнаяСуммаПродажи Тогда
						МаксимальнаяСуммаПродажи = СтрокаИтоговойТаблицы.СуммаПродажи;
						СтрокаСМаксимальнойСуммой = СтрокаИтоговойТаблицы;
					КонецЕсли;
					Если СтрокаИтоговойТаблицы.СуммаПродажи > МаксимальнаяСуммаПродажиБезДоговора Тогда
						Если НЕ ЗначениеЗаполнено(СтрокаИтоговойТаблицы.Договор) Тогда
							МаксимальнаяСуммаПродажиБезДоговора = СтрокаИтоговойТаблицы.СуммаПродажи;
							СтрокаСМаксимальнойСуммойБезДоговора = СтрокаИтоговойТаблицы;
						КонецЕсли;
					КонецЕсли;
					ОстатокСуммыПродажи = ОстатокСуммыПродажи - СтрокаИтоговойТаблицы.СуммаПродажи;
				КонецЕсли;
			КонецЕсли;
			
			Если ОстатокСуммыПродажи <> 0 Тогда
				Если СтрокаСМаксимальнойСуммойБезДоговора <> Неопределено Тогда
					СтрокаСМаксимальнойСуммойБезДоговора.СуммаПродажи = СтрокаСМаксимальнойСуммой.СуммаПродажи + ОстатокСуммыПродажи;
				ИначеЕсли СтрокаСМаксимальнойСуммой <> Неопределено Тогда
					СтрокаСМаксимальнойСуммой.СуммаПродажи = СтрокаСМаксимальнойСуммой.СуммаПродажи + ОстатокСуммыПродажи;
				// Иначе копейки потеряли.
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ТаблицаТоварыОрганизаций = ИтоговаяТаблица;
	ТаблицаТоварыОрганизаций.Свернуть("Период, ВидДвижения, Номенклатура, Характеристика, Склад, Организация, Поставщик, Договор, НомерГТД, ОрганизацияОтгрузки, НомерСтрокиДокумента", "Количество, СуммаПродажи");
	
КонецПроцедуры

Функция ТаблицаОстатковОрганизаций(ТаблицаТоварыОрганизаций, ДокументСсылка, Период) Экспорт
	
	ПриоритетыРеализацииТоваров = Константы.ПриоритетыРеализацииТоваров.Получить();
	ПриоритетКомиссионного = ПриоритетыРеализацииТоваров = Перечисления.ПриоритетыРеализацииТоваров.Комиссионный;
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.ТоварыОрганизаций");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.ИсточникДанных = ТаблицаТоварыОрганизаций;
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Организация", "Организация");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Склад", "Склад");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Номенклатура", "Номенклатура");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Характеристика", "Характеристика");
	Блокировка.Заблокировать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаТоварыОрганизаций.ВидДвижения КАК ВидДвижения,
	|	ТаблицаТоварыОрганизаций.Номенклатура КАК Номенклатура,
	|	ТаблицаТоварыОрганизаций.Характеристика КАК Характеристика,
	|	ТаблицаТоварыОрганизаций.Организация КАК Организация,
	|	ТаблицаТоварыОрганизаций.Склад КАК Склад
	|ПОМЕСТИТЬ ТаблицаТоварыОрганизаций
	|ИЗ
	|	&ТаблицаТоварыОрганизаций КАК ТаблицаТоварыОрганизаций
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДвиженияДокумента.Номенклатура КАК Номенклатура,
	|	ДвиженияДокумента.Характеристика КАК Характеристика,
	|	ДвиженияДокумента.Склад КАК Склад,
	|	ДвиженияДокумента.Организация КАК Организация,
	|	ДвиженияДокумента.Поставщик КАК Поставщик,
	|	ДвиженияДокумента.Договор КАК Договор,
	|	ДвиженияДокумента.НомерГТД КАК НомерГТД,
	|	СУММА(ВЫБОР
	|			КОГДА ДвиженияДокумента.ВидДвижения = &Расход
	|				ТОГДА ДвиженияДокумента.Количество
	|			ИНАЧЕ -ДвиженияДокумента.Количество
	|		КОНЕЦ) КАК Количество
	|ПОМЕСТИТЬ ДвиженияДокумента
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДвиженияДокумента
	|ГДЕ
	|	ДвиженияДокумента.Регистратор = &Ссылка
	|	И ДвиженияДокумента.Период < &Период
	|
	|СГРУППИРОВАТЬ ПО
	|	ДвиженияДокумента.Номенклатура,
	|	ДвиженияДокумента.Характеристика,
	|	ДвиженияДокумента.Склад,
	|	ДвиженияДокумента.Организация,
	|	ДвиженияДокумента.Поставщик,
	|	ДвиженияДокумента.Договор,
	|	ДвиженияДокумента.НомерГТД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&Период КАК Период,
	|	&Расход КАК ВидДвижения,
	|	ОстаткиИтоговые.Номенклатура КАК Номенклатура,
	|	ОстаткиИтоговые.Характеристика КАК Характеристика,
	|	ОстаткиИтоговые.Склад КАК Склад,
	|	ОстаткиИтоговые.Организация КАК Организация,
	|	ОстаткиИтоговые.Организация КАК ОрганизацияОтгрузки,
	|	ОстаткиИтоговые.Поставщик КАК Поставщик,
	|	ОстаткиИтоговые.Договор КАК Договор,
	|	ОстаткиИтоговые.НомерГТД КАК НомерГТД,
	|	ВЫБОР
	|		КОГДА &ПриоритетКомиссионного
	|			ТОГДА ОстаткиИтоговые.Договор = &ДоговорПустой
	|		ИНАЧЕ НЕ ОстаткиИтоговые.Договор = &ДоговорПустой
	|	КОНЕЦ КАК ПолеУпорядочивания,
	|	СУММА(ОстаткиИтоговые.Количество) КАК Количество
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТоварыОстатки.Номенклатура КАК Номенклатура,
	|		ТоварыОстатки.Характеристика КАК Характеристика,
	|		ТоварыОстатки.Склад КАК Склад,
	|		ТоварыОстатки.Организация КАК Организация,
	|		ТоварыОстатки.Поставщик КАК Поставщик,
	|		ТоварыОстатки.Договор КАК Договор,
	|		ТоварыОстатки.НомерГТД КАК НомерГТД,
	|		ТоварыОстатки.КоличествоОстаток КАК Количество
	|	ИЗ
	|		РегистрНакопления.ТоварыОрганизаций.Остатки(
	|				&ПериодОстатков,
	|				(Номенклатура, Характеристика, Склад, Организация) В
	|					(ВЫБРАТЬ
	|						ТаблицаТоварыОрганизаций.Номенклатура КАК Номенклатура,
	|						ТаблицаТоварыОрганизаций.Характеристика КАК Характеристика,
	|						ТаблицаТоварыОрганизаций.Склад КАК Склад,
	|						ТаблицаТоварыОрганизаций.Организация КАК Организация
	|					ИЗ
	|						ТаблицаТоварыОрганизаций КАК ТаблицаТоварыОрганизаций
	|					ГДЕ
	|						ТаблицаТоварыОрганизаций.ВидДвижения = &Расход)) КАК ТоварыОстатки
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДвиженияДокумента.Номенклатура,
	|		ДвиженияДокумента.Характеристика,
	|		ДвиженияДокумента.Склад,
	|		ДвиженияДокумента.Организация,
	|		ДвиженияДокумента.Поставщик,
	|		ДвиженияДокумента.Договор,
	|		ДвиженияДокумента.НомерГТД,
	|		ДвиженияДокумента.Количество
	|	ИЗ
	|		ДвиженияДокумента КАК ДвиженияДокумента) КАК ОстаткиИтоговые
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиИтоговые.Номенклатура,
	|	ОстаткиИтоговые.Характеристика,
	|	ОстаткиИтоговые.Склад,
	|	ОстаткиИтоговые.Организация,
	|	ОстаткиИтоговые.Поставщик,
	|	ОстаткиИтоговые.Договор,
	|	ОстаткиИтоговые.НомерГТД,
	|	ОстаткиИтоговые.Организация
	|
	|ИМЕЮЩИЕ
	|	СУММА(ОстаткиИтоговые.Количество) > 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПолеУпорядочивания
	|";
	
	Запрос.УстановитьПараметр("ТаблицаТоварыОрганизаций", ТаблицаТоварыОрганизаций);
	Запрос.УстановитьПараметр("Период", Период);
	Запрос.УстановитьПараметр("ПериодОстатков", Новый Граница(ДокументСсылка.МоментВремени(), ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("ПриоритетКомиссионного", ПриоритетКомиссионного);
	Запрос.УстановитьПараметр("ДоговорПустой", Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка());
	Запрос.УстановитьПараметр("Расход", ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);
	
	Результат = Запрос.Выполнить();
	ТаблицаОстатков = Результат.Выгрузить();
	
	Возврат ТаблицаОстатков;
	
КонецФункции

Функция ТаблицаДвиженийКомитенту(Знач ТаблицаТоварыОрганизаций, ЕстьДанныеДляОтчетаКомитенту) Экспорт
	
	Если ЕстьДанныеДляОтчетаКомитенту Тогда
		ВозвращаемаяТаблица = ТаблицаТоварыОрганизаций.Скопировать();
		ВозвращаемаяТаблица.Свернуть("Период, ВидДвижения, Номенклатура, Характеристика, Склад, Организация, Поставщик, Договор, НомерГТД", "Количество, СуммаПродажи");
		ВозвращаемаяТаблица.Колонки.Добавить("КоличествоСписано", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("ВидДвижения", ВидДвиженияНакопления.Приход);
		СтрокиТаблицы = ВозвращаемаяТаблица.НайтиСтроки(СтруктураПоиска);
		Для Каждого СтрокаТаблицы Из СтрокиТаблицы Цикл
			ВозвращаемаяТаблица.Удалить(СтрокаТаблицы)
		КонецЦикла;
		
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Договор", Справочники.ДоговорыПлатежныхАгентов.ПустаяСсылка());
		СтрокиТаблицы = ВозвращаемаяТаблица.НайтиСтроки(СтруктураПоиска);
		Для Каждого СтрокаТаблицы Из СтрокиТаблицы Цикл
			ВозвращаемаяТаблица.Удалить(СтрокаТаблицы)
		КонецЦикла;
		
		ВозвращаемаяТаблица.ЗаполнитьЗначения(ВидДвиженияНакопления.Приход, "ВидДвижения");
	Иначе
		ВозвращаемаяТаблица = ТаблицаТоварыОрганизаций.СкопироватьКолонки();
	КонецЕсли;
	
	Возврат ВозвращаемаяТаблица;
	
КонецФункции

Функция ТаблицаДвиженийКомитентуДляСписания(Знач ТаблицаТоварыОрганизаций, ЕстьДанныеДляОтчетаКомитенту) Экспорт
	
	Если ЕстьДанныеДляОтчетаКомитенту Тогда
		ВозвращаемаяТаблица = ТаблицаТоварыОрганизаций.Скопировать();
		ВозвращаемаяТаблица.Свернуть("Период, ВидДвижения, Номенклатура, Характеристика, Склад, Организация, Поставщик, Договор, НомерГТД", "Количество, СуммаПродажи");
		ВозвращаемаяТаблица.Колонки.Добавить("КоличествоСписано", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
		УдаляемыеСтроки = Новый Массив;
		Для Каждого СтрокаКомитенту Из ВозвращаемаяТаблица Цикл
			Если СтрокаКомитенту.ВидДвижения = ВидДвиженияНакопления.Приход
				ИЛИ НЕ ЗначениеЗаполнено(СтрокаКомитенту.Договор) Тогда
				УдаляемыеСтроки.Добавить(СтрокаКомитенту);
			Иначе
				СтрокаКомитенту.ВидДвижения = ВидДвиженияНакопления.Приход;
				СтрокаКомитенту.КоличествоСписано = СтрокаКомитенту.Количество;
				СтрокаКомитенту.Количество = 0;
			КонецЕсли;
		КонецЦикла;
		Для Каждого УдаляемаяСтрока Из УдаляемыеСтроки Цикл
			ВозвращаемаяТаблица.Удалить(УдаляемаяСтрока)
		КонецЦикла;
	Иначе
		ВозвращаемаяТаблица = ТаблицаТоварыОрганизаций.СкопироватьКолонки();
	КонецЕсли;
	
	Возврат ВозвращаемаяТаблица;
	
КонецФункции

#КонецОбласти

#КонецОбласти
