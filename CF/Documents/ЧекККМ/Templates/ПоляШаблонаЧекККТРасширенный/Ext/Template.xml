<?xml version="1.0" encoding="UTF-8"?>
<DataCompositionSchema xmlns="http://v8.1c.ru/8.1/data-composition-system/schema" xmlns:dcscom="http://v8.1c.ru/8.1/data-composition-system/common" xmlns:dcscor="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xmlns:v8="http://v8.1c.ru/8.1/data/core" xmlns:v8ui="http://v8.1c.ru/8.1/data/ui" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<dataSource>
		<name>ИсточникДанных1</name>
		<dataSourceType>Local</dataSourceType>
	</dataSource>
	<dataSet xsi:type="DataSetQuery">
		<name>НаборДанныхЧек</name>
		<field xsi:type="DataSetFieldField">
			<dataPath>Ссылка</dataPath>
			<field>Ссылка</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ИмяТаблицы</dataPath>
			<field>ИмяТаблицы</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Имя таблицы</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Сумма</dataPath>
			<field>Сумма</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>СтавкаНДС</dataPath>
			<field>СтавкаНДС</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Количество</dataPath>
			<field>Количество</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Количество</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Цена</dataPath>
			<field>Цена</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Цена</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Наименование</dataPath>
			<field>Наименование</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Наименование</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ДисконтнаяКарта</dataPath>
			<field>ДисконтнаяКарта</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>КоличествоБонусныхБаллов</dataPath>
			<field>КоличествоБонусныхБаллов</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>БонуснаяПрограммаЛояльности</dataPath>
			<field>БонуснаяПрограммаЛояльности</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Штрихкод</dataPath>
			<field>Штрихкод</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>НомерСтрокиТовара</dataPath>
			<field>НомерСтрокиТовара</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Номер строки товара</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ИдентификаторЧекаДляСкидки</dataPath>
			<field>ИдентификаторЧекаДляСкидки</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Идентификатор чека для скидки</v8:content>
				</v8:item>
			</title>
			<role>
				<dcscom:dimension>true</dcscom:dimension>
			</role>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>СуммаСкидки</dataPath>
			<field>СуммаСкидки</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Сумма скидки</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>СуммаБезСкидки</dataPath>
			<field>СуммаБезСкидки</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Сумма без скидки</v8:content>
				</v8:item>
			</title>
		</field>
		<dataSource>ИсточникДанных1</dataSource>
		<query>ВЫБРАТЬ
	МАКСИМУМ(ОднократныеСкидки.ИдентификаторСкидки) КАК ИдентификаторСкидки
ПОМЕСТИТЬ ИдентификаторыСкидок
ИЗ
	РегистрСведений.СостоянияОднократныхСкидокИКупонов КАК ОднократныеСкидки
ГДЕ
	ОднократныеСкидки.ДокументДвижения = &amp;ДокументСсылка
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	Товары.Номенклатура КАК Номенклатура,
	Товары.Характеристика КАК Характеристика,
	МАКСИМУМ(Штрихкоды.Штрихкод) КАК Штрихкод
ПОМЕСТИТЬ Штрихкоды
ИЗ
	Документ.ЧекККМ.Товары КАК Товары
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
		ПО Товары.Номенклатура = Штрихкоды.Владелец
			И Товары.Характеристика = Штрихкоды.Характеристика
ГДЕ
	Товары.Ссылка = &amp;ДокументСсылка

СГРУППИРОВАТЬ ПО
	Товары.Номенклатура,
	Товары.Характеристика
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	"СоставЧека" КАК ИмяТаблицы,
	Таблица.Ссылка КАК Ссылка,
	Таблица.ДисконтнаяКарта КАК ДисконтнаяКарта,
	ИдентификаторыСкидок.ИдентификаторСкидки КАК ИдентификаторЧекаДляСкидки,
	NULL КАК НомерСтрокиТовара,
	NULL КАК Наименование,
	NULL КАК Количество,
	NULL КАК Цена,
	NULL КАК Сумма,
	NULL КАК СуммаБезСкидки,
	NULL КАК СуммаСкидки,
	NULL КАК СтавкаНДС,
	NULL КАК Штрихкод,
	Таблица.ДисконтнаяКарта.БонуснаяПрограммаЛояльности КАК БонуснаяПрограммаЛояльности,
	NULL КАК КоличествоБонусныхБаллов
{ВЫБРАТЬ
	ИмяТаблицы КАК ИмяТаблицы,
	Ссылка КАК Ссылка,
	ДисконтнаяКарта КАК ДисконтнаяКарта,
	ИдентификаторЧекаДляСкидки КАК ИдентификаторЧекаДляСкидки,
	НомерСтрокиТовара КАК НомерСтрокиТовара,
	Наименование КАК Наименование,
	Количество КАК Количество,
	Цена КАК Цена,
	Сумма КАК Сумма,
	СтавкаНДС КАК СтавкаНДС,
	Штрихкод КАК Штрихкод,
	БонуснаяПрограммаЛояльности КАК БонуснаяПрограммаЛояльности,
	КоличествоБонусныхБаллов КАК КоличествоБонусныхБаллов}
ИЗ
	Документ.ЧекККМ КАК Таблица
		ЛЕВОЕ СОЕДИНЕНИЕ ИдентификаторыСкидок КАК ИдентификаторыСкидок
		ПО (ИСТИНА)
ГДЕ
	Таблица.Ссылка = &amp;ДокументСсылка

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	"Товары",
	Таблица.Ссылка,
	NULL,
	NULL,
	Таблица.НомерСтроки,
	Таблица.Номенклатура.Наименование,
	Таблица.КоличествоУпаковок,
	ВЫБОР
		КОГДА Таблица.КоличествоУпаковок = 0
			ТОГДА Таблица.Сумма
		ИНАЧЕ Таблица.Сумма / Таблица.КоличествоУпаковок
	КОНЕЦ,
	Таблица.Сумма,
	Таблица.Сумма + Таблица.СуммаАвтоматическойСкидки + Таблица.СуммаРучнойСкидки + Таблица.СуммаСкидкиОплатыБонусом,
	Таблица.СуммаАвтоматическойСкидки + Таблица.СуммаРучнойСкидки + Таблица.СуммаСкидкиОплатыБонусом,
	Таблица.СтавкаНДС,
	Штрихкоды.Штрихкод,
	NULL,
	NULL
ИЗ
	Документ.ЧекККМ.Товары КАК Таблица
		ЛЕВОЕ СОЕДИНЕНИЕ Штрихкоды КАК Штрихкоды
		ПО Таблица.Номенклатура = Штрихкоды.Номенклатура
			И Таблица.Характеристика = Штрихкоды.Характеристика
ГДЕ
	Таблица.Ссылка = &amp;ДокументСсылка

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	"БонусныеБаллыКНачислению",
	ЕСТЬNULL(Таблица.Ссылка, Чек.Ссылка),
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	Таблица.БонуснаяПрограммаЛояльности,
	СУММА(ЕСТЬNULL(Таблица.КоличествоБонусныхБаллов, 0))
ИЗ
	Документ.ЧекККМ КАК Чек
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЧекККМ.БонусныеБаллыКНачислению КАК Таблица
		ПО Чек.Ссылка = Таблица.Ссылка
ГДЕ
	Чек.Ссылка = &amp;ДокументСсылка

СГРУППИРОВАТЬ ПО
	ЕСТЬNULL(Таблица.Ссылка, Чек.Ссылка),
	Таблица.БонуснаяПрограммаЛояльности</query>
	</dataSet>
	<parameter>
		<name>ДокументСсылка</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Документ ссылка</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type xmlns:d4p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d4p1:DocumentRef.ЧекККМ</v8:Type>
		</valueType>
		<value xsi:nil="true"/>
		<useRestriction>false</useRestriction>
		<use>Always</use>
	</parameter>
	<settingsVariant>
		<dcsset:name>Основной</dcsset:name>
		<dcsset:presentation xsi:type="xs:string">Основной</dcsset:presentation>
		<dcsset:settings xmlns:style="http://v8.1c.ru/8.1/data/ui/style" xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system" xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web" xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows">
			<dcsset:selection>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ИмяТаблицы</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Ссылка</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ДисконтнаяКарта</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>ИдентификаторЧекаДляСкидки</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>НомерСтрокиТовара</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Наименование</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Количество</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Цена</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Сумма</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>СуммаБезСкидки</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>СтавкаНДС</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>СуммаСкидки</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>Штрихкод</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>БонуснаяПрограммаЛояльности</dcsset:field>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:SelectedItemField">
					<dcsset:field>КоличествоБонусныхБаллов</dcsset:field>
				</dcsset:item>
			</dcsset:selection>
			<dcsset:dataParameters>
				<dcscor:item xsi:type="dcsset:SettingsParameterValue">
					<dcscor:parameter>ДокументСсылка</dcscor:parameter>
					<dcscor:value xsi:nil="true"/>
				</dcscor:item>
			</dcsset:dataParameters>
			<dcsset:item xsi:type="dcsset:StructureItemGroup">
				<dcsset:order>
					<dcsset:item xsi:type="dcsset:OrderItemAuto"/>
				</dcsset:order>
				<dcsset:selection>
					<dcsset:item xsi:type="dcsset:SelectedItemAuto"/>
				</dcsset:selection>
			</dcsset:item>
		</dcsset:settings>
	</settingsVariant>
</DataCompositionSchema>